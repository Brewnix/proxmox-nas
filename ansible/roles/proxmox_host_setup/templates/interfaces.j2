# Proxmox Network Interface Configuration
# This file is managed by Ansible - changes will be overwritten

auto lo
iface lo inet loopback

# Primary management interface
auto {{ network.interface | default('enp1s0') }}
iface {{ network.interface | default('enp1s0') }} inet static
    address {{ network.management_ip | default('192.168.1.100/24') }}
    gateway {{ network.gateway | default('192.168.1.1') }}
    dns-nameservers {{ network.dns | default('8.8.8.8 1.1.1.1') }}

{% if network.vlan_id is defined %}
# NAS VLAN interface
auto {{ network.interface | default('enp1s0') }}.{{ network.vlan_id }}
iface {{ network.interface | default('enp1s0') }}.{{ network.vlan_id }} inet static
    address {{ network.ip_range | ipaddr('1') | ipaddr('address') }}/24
    vlan-raw-device {{ network.interface | default('enp1s0') }}
{% endif %}

# Proxmox bridge for VMs and containers
auto vmbr0
iface vmbr0 inet static
    address {{ network.bridge_ip | default(network.management_ip | ipaddr('address')) }}
    netmask {{ network.netmask | default('255.255.255.0') }}
{% if network.vlan_id is defined %}
    bridge-ports {{ network.interface | default('enp1s0') }}.{{ network.vlan_id }}
{% else %}
    bridge-ports {{ network.interface | default('enp1s0') }}
{% endif %}
    bridge-stp off
    bridge-fd 0
    bridge-vlan-aware yes
    bridge-vids 2-4094

{% if network.additional_bridges is defined %}
{% for bridge in network.additional_bridges %}
# Additional bridge: {{ bridge.name }}
auto {{ bridge.name }}
iface {{ bridge.name }} inet {{ bridge.type | default('static') }}
{% if bridge.type == 'static' or bridge.type is not defined %}
    address {{ bridge.address }}
    netmask {{ bridge.netmask | default('255.255.255.0') }}
{% endif %}
    bridge-ports {{ bridge.ports | default('none') }}
    bridge-stp off
    bridge-fd 0
{% if bridge.vlan_aware is defined and bridge.vlan_aware %}
    bridge-vlan-aware yes
    bridge-vids {{ bridge.vlan_range | default('2-4094') }}
{% endif %}

{% endfor %}
{% endif %}
