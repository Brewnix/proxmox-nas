# Samba Configuration for NAS
# Generated by Ansible on {{ ansible_date_time.iso8601 }}

[global]
    workgroup = {{ samba_workgroup | default('WORKGROUP') }}
    server string = {{ ansible_hostname }} NAS Server
    netbios name = {{ ansible_hostname | upper }}
    security = user
    map to guest = bad user
    dns proxy = no
    load printers = no
    printing = bsd
    printcap name = /dev/null
    disable spoolss = yes
    
    # Performance optimizations
    socket options = TCP_NODELAY IPTOS_LOWDELAY SO_RCVBUF=65536 SO_SNDBUF=65536
    read raw = yes
    write raw = yes
    max xmit = 65535
    dead time = 15
    getwd cache = yes
    
    # Security
    encrypt passwords = yes
    smb encrypt = auto
    server min protocol = SMB2_10
    
    # Logging
    log file = /var/log/samba/log.%m
    max log size = 1000
    log level = 1
    
    # Character encoding
    unix charset = UTF-8
    dos charset = CP850

{% for share in samba_shares | default([]) %}
[{{ share.name }}]
    comment = {{ share.comment | default(share.name + ' Share') }}
    path = {{ share.path }}
    browseable = {{ share.browseable | default('yes') }}
    writable = {{ share.writable | default('yes') }}
    guest ok = {{ share.guest_ok | default('no') }}
    valid users = {{ share.valid_users | default('@users') }}
    create mask = {{ share.create_mask | default('0664') }}
    directory mask = {{ share.directory_mask | default('0775') }}
    force user = {{ share.force_user | default('nobody') }}
    force group = {{ share.force_group | default('nogroup') }}
{% if share.read_only | default(false) %}
    read only = yes
{% endif %}
{% if share.recycle | default(false) %}
    vfs objects = recycle
    recycle:repository = .recycle
    recycle:keeptree = yes
    recycle:versions = yes
    recycle:touch = yes
    recycle:directory_mode = 0775
    recycle:subdir_mode = 0700
{% endif %}

{% endfor %}

# Default shares if none specified
{% if samba_shares is not defined or samba_shares | length == 0 %}
[nas-data]
    comment = NAS Data Share
    path = /nas-data
    browseable = yes
    writable = yes
    guest ok = no
    valid users = @users
    create mask = 0664
    directory mask = 0775
    force user = nobody
    force group = nogroup

[media]
    comment = Media Share
    path = /nas-data/media
    browseable = yes
    writable = yes
    guest ok = yes
    create mask = 0664
    directory mask = 0775
    force user = nobody
    force group = nogroup

[documents]
    comment = Documents Share
    path = /nas-data/documents
    browseable = yes
    writable = yes
    guest ok = no
    valid users = @users
    create mask = 0664
    directory mask = 0775
    force user = nobody
    force group = nogroup

[backups]
    comment = Backup Share
    path = /nas-data/backups
    browseable = yes
    writable = yes
    guest ok = no
    valid users = @users
    create mask = 0664
    directory mask = 0775
    force user = nobody
    force group = nogroup
    vfs objects = recycle
    recycle:repository = .recycle
    recycle:keeptree = yes
    recycle:versions = yes
{% endif %}
