#!/bin/bash
# ZFS Snapshot Management Script
# Creates and manages ZFS snapshots

set -e

SNAPSHOT_TYPE="${1:-hourly}"
DATE=$(date +%Y%m%d_%H%M%S)

# Snapshot datasets
DATASETS=(
    "data/nas-data"
    "data/vm-storage"
    "data/container-storage"
)

# Create snapshots
for dataset in "${DATASETS[@]}"; do
    if zfs list "$dataset" >/dev/null 2>&1; then
        zfs snapshot "$dataset@$SNAPSHOT_TYPE-$DATE"
        echo "Created snapshot: $dataset@$SNAPSHOT_TYPE-$DATE"
    fi
done

# Clean up old snapshots
case "$SNAPSHOT_TYPE" in
    hourly)
        # Keep last 24 hourly snapshots
        for dataset in "${DATASETS[@]}"; do
            zfs list -t snapshot -o name "$dataset" | grep "@hourly-" | head -n -24 | xargs -r zfs destroy
        done
        ;;
    daily)
        # Keep last 7 daily snapshots
        for dataset in "${DATASETS[@]}"; do
            zfs list -t snapshot -o name "$dataset" | grep "@daily-" | head -n -7 | xargs -r zfs destroy
        done
        ;;
    weekly)
        # Keep last 4 weekly snapshots
        for dataset in "${DATASETS[@]}"; do
            zfs list -t snapshot -o name "$dataset" | grep "@weekly-" | head -n -4 | xargs -r zfs destroy
        done
        ;;
esac

echo "Snapshot cleanup complete"
