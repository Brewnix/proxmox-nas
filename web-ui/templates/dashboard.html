<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Proxmox NAS - GitOps Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="fas fa-server"></i> Proxmox NAS
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/"><i class="fas fa-tachometer-alt"></i> Dashboard</a>
                <a class="nav-link" href="/sites"><i class="fas fa-cogs"></i> Sites</a>
                <a class="nav-link" href="/deploy"><i class="fas fa-rocket"></i> Deploy</a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row">
            <div class="col-md-12">
                <h1><i class="fas fa-tachometer-alt"></i> System Dashboard</h1>
                <p class="text-muted">GitOps-driven Proxmox NAS management</p>
            </div>
        </div>

        <div class="row mt-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-hdd"></i> Storage Status</h5>
                    </div>
                    <div class="card-body">
                        <pre id="storage-status">Loading...</pre>
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-desktop"></i> VM/Container Status</h5>
                    </div>
                    <div class="card-body">
                        <div id="vm-status">Loading...</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-code-branch"></i> GitOps Status</h5>
                    </div>
                    <div class="card-body">
                        <div id="git-status">Loading...</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-play"></i> Quick Actions</h5>
                    </div>
                    <div class="card-body">
                        <div class="d-grid gap-2 d-md-flex">
                            <button class="btn btn-primary" onclick="triggerDeployment()">
                                <i class="fas fa-rocket"></i> Deploy Updates
                            </button>
                            <button class="btn btn-secondary" onclick="createBackup()">
                                <i class="fas fa-save"></i> Create Backup
                            </button>
                            <button class="btn btn-info" onclick="refreshStatus()">
                                <i class="fas fa-sync"></i> Refresh Status
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        async function loadStatus() {
            try {
                const [systemResponse, vmResponse] = await Promise.all([
                    fetch('/api/status'),
                    fetch('/api/vms')
                ]);

                const systemData = await systemResponse.json();
                const vmData = await vmResponse.json();

                // Update storage status
                document.getElementById('storage-status').textContent =
                    `Hostname: ${systemData.hostname}\n` +
                    `Disk Usage:\n${systemData.disk_usage}\n` +
                    `Memory:\n${systemData.memory}`;

                // Update VM status
                let vmHtml = '<ul class="list-group">';
                vmData.vms?.forEach(vm => {
                    vmHtml += `<li class="list-group-item d-flex justify-content-between align-items-center">
                        ${vm.name} (VMID: ${vm.vmid})
                        <span class="badge bg-${vm.status === 'running' ? 'success' : 'secondary'}">${vm.status}</span>
                    </li>`;
                });
                vmData.containers?.forEach(container => {
                    vmHtml += `<li class="list-group-item d-flex justify-content-between align-items-center">
                        ${container.name} (VMID: ${container.vmid})
                        <span class="badge bg-${container.status === 'running' ? 'success' : 'secondary'}">${container.status}</span>
                    </li>`;
                });
                vmHtml += '</ul>';
                document.getElementById('vm-status').innerHTML = vmHtml;

            } catch (error) {
                console.error('Error loading status:', error);
            }
        }

        async function triggerDeployment() {
            if (confirm('Trigger GitOps deployment?')) {
                try {
                    const response = await fetch('/deploy', { method: 'POST' });
                    const result = await response.text();
                    alert('Deployment triggered: ' + result);
                    loadStatus();
                } catch (error) {
                    alert('Deployment failed: ' + error);
                }
            }
        }

        function createBackup() {
            alert('Backup functionality coming soon!');
        }

        function refreshStatus() {
            loadStatus();
        }

        // Load status on page load
        loadStatus();

        // Refresh every 30 seconds
        setInterval(loadStatus, 30000);
    </script>
</body>
</html>
